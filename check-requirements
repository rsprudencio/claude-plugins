#!/usr/bin/env bash
# Jarvis requirements checker - delegates to Python when available
# Run this BEFORE installing the plugin to verify your system is ready.

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "============================================================"
echo "Jarvis Requirements Check - $(uname -s)"
echo "============================================================"
echo ""

# Check for Python first
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}✗${NC} python3 not found"
    echo ""
    echo "Python 3.10+ is required to run Jarvis."
    echo ""
    echo "Install instructions:"
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "  • Homebrew: brew install python3"
        echo "  • Official: https://www.python.org/downloads/"
    elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
        echo "  • Official: https://www.python.org/downloads/"
        echo "  • Microsoft Store: search for Python 3.11+"
    else
        echo "  • Debian/Ubuntu: sudo apt install python3"
        echo "  • RedHat/CentOS: sudo yum install python3"
        echo "  • Official: https://www.python.org/downloads/"
    fi
    echo ""
    exit 1
fi

# Python exists - check version
PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
PYTHON_MAJOR=$(echo "$PYTHON_VERSION" | cut -d. -f1)
PYTHON_MINOR=$(echo "$PYTHON_VERSION" | cut -d. -f2)

if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 10 ]); then
    echo -e "${RED}✗${NC} Python $PYTHON_VERSION found (requires 3.10+)"
    echo ""
    echo "Please upgrade to Python 3.10 or later."
    echo ""
    exit 1
fi

echo -e "${GREEN}✓${NC} Python $PYTHON_VERSION found"
echo ""

# Delegate to Python module for detailed checks
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export PYTHONPATH="${SCRIPT_DIR}/plugins/jarvis/mcp-server:${PYTHONPATH}"

python3 - "$@" <<'EOF'
import sys
from tools.system_check import run_system_check, format_check_result

# Check for verbose flag
verbose = "--verbose" in sys.argv or "-v" in sys.argv

# Run comprehensive checks
result = run_system_check()

# Format and print (skip Python check since bash already did it)
output = format_check_result(result, verbose=verbose)
print(output)

# Exit with appropriate code
if result["healthy"]:
    print("You're ready to install Jarvis:")
    print("  claude plugin install jarvis@raph-claude-plugins")
    sys.exit(0)
else:
    print("Please install missing requirements before installing Jarvis plugin.")
    sys.exit(1)
EOF
